<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Metamask meta transaction test</title>
	<script>
		async function main() {
			if (!window.ethereum || !window.ethereum.isMetaMask) {
				console.log("Please install MetaMask")
				return
			}

			const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
			const chainId = await window.ethereum.request({ method: 'eth_chainId' });
			console.log(chainId);
			const eip712domain_type_definition = {
				"EIP712Domain": [
					{
						"name": "name",
						"type": "string"
					},
					{
						"name": "version",
						"type": "string"
					},
					{
						"name": "chainId",
						"type": "uint256"
					},
					{
						"name": "verifyingContract",
						"type": "address"
					}
				]
			}
			const karma_request_domain = {
				"name": "Frequency",
				"version": "1",
				"chainId": chainId,
				"verifyingContract": "0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC"
			}

			document.getElementById('itemized_request')?.addEventListener("click", async function () {
				const signature_request = {
					"types": {
						...eip712domain_type_definition,
						"ItemizedSignaturePayloadV2": [
							{
								"name": "schemaId",
								"type": "uint32"
							},
							{
								"name": "targetHash",
								"type": "uint64"
							},
							{
								"name": "expiration",
								"type": "uint64"
							},
							{
								"name": "actions",
								"type": "ItemAction[]"
							},
						],
						"ItemAction": [
							{ "name": 'actionType', "type": 'string' },
							{ "name": 'data', "type": 'bytes' },
							{ "name": 'index', "type": 'uint16' }
						]
					},
					"primaryType": "ItemizedSignaturePayloadV2",
					"domain": karma_request_domain,
					"message": {
						"schemaId": 10,
						"targetHash": 1982672367,
						"expiration": 100,
						"actions": [
							{
								"actionType": "Add",
								"data": '0x40a6836ea489047852d3f0297f8fe8ad6779793af4e9c6274c230c207b9b825026',
								"index": 0
							},
							{
								"actionType": 'Delete',
								"data": '0x',
								"index": 2
							}
						]
					}
				}
				console.log(JSON.stringify({
					"method": "eth_signTypedData_v4",
					"params": [
						accounts[0],
						signature_request
					]
				},null, 2));
				let signature = await window.ethereum.request({
					"method": "eth_signTypedData_v4",
					"params": [
						accounts[0],
						signature_request
					]
				})
				console.log(signature);
				alert("Signature: " + signature)
			});

			document.getElementById('passkey_request')?.addEventListener("click", async function () {
				const signature_request = {
					"types": {
						...eip712domain_type_definition,
						"PasskeyPublicKey": [
							{
								"name": "publicKey",
								"type": "bytes"
							},
						],
					},
					"primaryType": "PasskeyPublicKey",
					"domain": karma_request_domain,
					"message": {
						"publicKey": '0x40a6836ea489047852d3f0297f8fe8ad6779793af4e9c6274c230c207b9b825026',
					}
				}
				console.log(JSON.stringify({
					"method": "eth_signTypedData_v4",
					"params": [
						accounts[0],
						signature_request
					]
				},null, 2));
				let signature = await window.ethereum.request({
					"method": "eth_signTypedData_v4",
					"params": [
						accounts[0],
						signature_request
					]
				})
				console.log(signature);
				alert("Signature: " + signature)
			});

			document.getElementById('handle_request')?.addEventListener("click", async function () {
				const signature_request = {
					"types": {
						...eip712domain_type_definition,
						"ClaimHandlePayload": [
							{
								"name": "handle",
								"type": "string"
							},
							{
								"name": "expiration",
								"type": "uint64"
							},
						],
					},
					"primaryType": "ClaimHandlePayload",
					"domain": karma_request_domain,
					"message": {
						"handle": 'Alice',
						"expiration": 100,
					}
				}
				console.log(JSON.stringify({
					"method": "eth_signTypedData_v4",
					"params": [
						accounts[0],
						signature_request
					]
				},null, 2));
				let signature = await window.ethereum.request({
					"method": "eth_signTypedData_v4",
					"params": [
						accounts[0],
						signature_request
					]
				})
				console.log(signature);
				alert("Signature: " + signature)
			});
		}
		main()
	</script>
</head>
<body>
<button id="itemized_request">Itemized Sign</button>
<button id="passkey_request">Passkey Sign</button>
<button id="handle_request">Handle Sign</button>
</body>
</html>
<!-- itemized 0x7efb5407412c745f40713ba0922e228bf5f2b628423817a7a333a36902df0df45ef4cfd3c309fcaf9c0fc72e91a96b5456740b345283fc4525f5b09802ad1c0d1c-->
<!--itemized partly 0xa489ad17602426140fc44836eecb300f38883b61f3d71411387356908f8d81dc2822a3278642dca6af296b23b6e35904f816a0564327324080ff26abfdcd05b31b-->
<!--passkey 0xbafaf5e21695a502b2d356b4558da35245aa1be7161f01a5f0224fbfdf85b5c52898fc495ab1ca9b68c3b07e23d31a5fe1686165344b22bc14201f293d54f36b1b-->
